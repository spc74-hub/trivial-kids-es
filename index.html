<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trivial Kids ES — v7.3</title>
  <meta name="description" content="Trivial para 1–4 jugadores. Carga de bancos JSON por archivo/URL, packs versionados, modo 'solo nuevas', archivado de tarjetas y puntuación corregida." />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel (para poder escribir JSX sin build) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body,#root{height:100%} .btn{ padding:.5rem .75rem; border-radius: .75rem; } .chip{ padding:.125rem .5rem; border-radius:.5rem; font-size:.75rem; font-weight:600; }</style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-800">
  <div id="root"></div>

  <!-- IMPORTANTE: data-presets="env,react" evita la pantalla en blanco en producción -->
  <script type="text/babel" data-presets="env,react">
    const {useEffect, useMemo, useRef, useState} = React;

    // =================== UTIL ===================
    const STORAGE = { setup:'trivial_v73_setup', answered:'trivial_v73_answered', archived:'trivial_v73_archived' };
    const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
    const cls = (...a)=>a.filter(Boolean).join(' ');
    const lsGet = (k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f }catch{ return f } };
    const lsSet = (k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)) }catch{} };
    const shuffle = (arr)=>{ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=(i*31+7)%(i+1); [a[i],a[j]]=[a[j],a[i]] } return a };
    const sanitize = (list)=> (list||[]).filter(q=> q && typeof q.id==='string' && typeof q.q==='string' && Array.isArray(q.options) && q.options.length===4 && Number.isInteger(q.correct) && q.correct>=0 && q.correct<4 && typeof q.cat==='string' && typeof q.diff==='string');

    // =================== CAT & DIFF ===================
    const DIFF = { EASY:'Fácil', MEDIUM:'Media', HARD:'Difícil', EXPERT:'Muy difícil' };
    const DIFF_COLOR = {
      EASY:'bg-emerald-100 text-emerald-900',
      MEDIUM:'bg-sky-100 text-sky-900',
      HARD:'bg-amber-100 text-amber-900',
      EXPERT:'bg-rose-100 text-rose-900'
    };

    const CATS = {
      GEO: { name:'Geografía', color:'bg-sky-100 text-sky-900' },
      HIS: { name:'Historia', color:'bg-amber-100 text-amber-900' },
      LEN: { name:'Lengua y Literatura', color:'bg-rose-100 text-rose-900' },
      SCI: { name:'Ciencia y Tecnología', color:'bg-emerald-100 text-emerald-900' },
      CUL: { name:'Cultura/Deporte', color:'bg-violet-100 text-violet-900' },
      LANG:{ name:'Idiomas (EN/FR)', color:'bg-yellow-100 text-yellow-900' },
      RIDDLE:{ name:'Adivinanzas', color:'bg-orange-100 text-orange-900' },
      MEDIA:{ name:'Películas/Juegos', color:'bg-indigo-100 text-indigo-900' },
      REL: { name:'Religión', color:'bg-teal-100 text-teal-900' },
      MUS: { name:'Música', color:'bg-fuchsia-100 text-fuchsia-900' }
    };

    // =================== EMBEDDED DEMO BANK ===================
    const EMBEDDED_BANK = {
      version:'demo-1',
      categories: Object.fromEntries(Object.entries(CATS).map(([k,v])=>[k,v.name])),
      questions: sanitize([
        {id:'GEO-e1', cat:'GEO', diff:'EASY', q:'Capital de España', options:['Madrid','Barcelona','Sevilla','Valencia'], correct:0, exp:'Madrid es la capital.'},
        {id:'HIS-e1', cat:'HIS', diff:'EASY', q:'Descubrimiento de América (año)', options:['1492','1500','1485','1510'], correct:0},
        {id:'SCI-e1', cat:'SCI', diff:'EASY', q:'Fórmula del agua', options:['H2O','CO2','O2','NaCl'], correct:0},
        {id:'LEN-m1', cat:'LEN', diff:'MEDIUM', q:'¿Qué es una metáfora?', options:["Comparación sin 'como'","Exageración","Contradicción","Imitación sonora"], correct:0},
        {id:'CUL-h1', cat:'CUL', diff:'HARD', q:'Goya 2020 a Mejor Película (España)', options:['Dolor y gloria','Mientras dure la guerra','La trinchera infinita','O que arde'], correct:0},
        {id:'LANG-e1', cat:'LANG', diff:'EASY', q:"EN: Past of 'go'", options:['went','goed','gone','goes'], correct:0},
        {id:'RIDDLE-e1', cat:'RIDDLE', diff:'EASY', q:'Me rompo si me nombras', options:['El silencio','El secreto','La promesa','El hielo'], correct:0},
        {id:'MEDIA-e1', cat:'MEDIA', diff:'EASY', q:"Héroe de 'The Legend of Zelda'", options:['Link','Zelda','Ganon','Mario'], correct:0},
        {id:'REL-m1', cat:'REL', diff:'MEDIUM', q:'Mes de ayuno en el islam', options:['Ramadán','Muharram','Safar','Shawwal'], correct:0},
        {id:'MUS-x1', cat:'MUS', diff:'EXPERT', q:'Acorde mayor básico', options:['Tónica, 3M, 5J','Tónica, 2, 4','Tónica, 3m, 5d','Solo tónica'], correct:0}
      ])
    };

    // =================== FETCH & MERGE ===================
    async function fetchJSON(url){ const res = await fetch(url, {cache:'no-store'}); if(!res.ok) throw new Error('No se pudo cargar '+url); return await res.json(); }
    function mergeBanks(banks){
      const categories = Object.fromEntries(Object.entries(CATS).map(([k,v])=>[k,v.name]));
      const map = new Map(); const versions=[];
      for(const b of banks){ if(!b) continue; if(b.categories) Object.assign(categories, b.categories); if(Array.isArray(b.questions)) for(const q of sanitize(b.questions)) map.set(q.id,q); if(b.version) versions.push(b.version); }
      return { version: versions.join('+')||'local', categories, questions: Array.from(map.values()) };
    }

    // =================== UI UTILS ===================
    function Toggle({on, onClick, children, className}){
      return <button onClick={onClick} className={cls('px-3 py-1.5 rounded-xl border text-sm', on? 'bg-slate-900 text-white border-slate-900':'bg-white border-slate-300 hover:bg-slate-50', className)}>{children}</button>;
    }

    function Logo(){
      // Pie de 6 colores (no marca registrada)
      return (
        <div className="flex items-center gap-2 select-none">
          <svg width="28" height="28" viewBox="0 0 100 100" aria-label="Logo Trivial Kids ES" role="img">
            <defs><circle id="c" cx="50" cy="50" r="46"/></defs>
            <g stroke="#0f172a" stroke-width="4" fill="none">
              <circle cx="50" cy="50" r="46" fill="#fff"/>
              <path d="M50,50 L50,4 A46,46 0 0,1 86.8,25 Z" fill="#22c55e"/>
              <path d="M50,50 L86.8,25 A46,46 0 0,1 86.8,75 Z" fill="#38bdf8"/>
              <path d="M50,50 L86.8,75 A46,46 0 0,1 50,96 Z" fill="#f59e0b"/>
              <path d="M50,50 L50,96 A46,46 0 0,1 13.2,75 Z" fill="#f43f5e"/>
              <path d="M50,50 L13.2,75 A46,46 0 0,1 13.2,25 Z" fill="#a78bfa"/>
              <path d="M50,50 L13.2,25 A46,46 0 0,1 50,4 Z" fill="#facc15"/>
              <circle cx="50" cy="50" r="14" fill="#0f172a"/>
            </g>
          </svg>
          <span className="text-xl sm:text-2xl font-extrabold tracking-tight">Trivial Kids ES</span>
          <span className="chip bg-slate-100 text-slate-700">v7.3</span>
        </div>
      );
    }

    // =================== BANK MANAGER ===================
    function BankManager({ bank, setBank, answered, archived }){
      const [url, setUrl] = useState('');
      const importFiles = async (files) => {
        const banks = [bank];
        for(const file of files){ try{ const json = JSON.parse(await file.text()); banks.push(json);}catch(e){ alert('Error en '+file.name+': '+e.message);} }
        setBank(mergeBanks(banks));
      };
      const importURL = async () => {
        try{ const json = await fetchJSON(url.trim()); setBank(mergeBanks([bank, json])); setUrl(''); }
        catch(e){ alert(e.message); }
      };
      const exportBank = () => {
        const blob = new Blob([JSON.stringify(bank,null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `bank-${bank.version||'local'}.json`; a.click();
      };
      return (
        <section className="p-4 rounded-2xl border bg-white shadow-sm">
          <div className="flex items-center justify-between gap-3">
            <h2 className="text-lg font-bold">Banco de preguntas</h2>
            <div className="text-xs text-slate-500">Versión: <span className="font-mono">{bank.version}</span> • Total: {bank.questions?.length||0} • Respondidas: {answered.size} • Archivadas: {archived.size}</div>
          </div>
          <div className="mt-3 grid md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <div className="text-sm font-semibold">Importar JSON (archivo/s):</div>
              <input type="file" accept="application/json" multiple onChange={(e)=>importFiles([...e.target.files])} />
              <div className="text-xs text-slate-500">Formato: {`{ version, categories, questions:[{ id, cat, diff, q, options[4], correct, exp? }] }`}. IDs únicas y estables.</div>
              <div className="flex gap-2 mt-2">
                <input className="flex-1 px-3 py-2 rounded-xl border" placeholder="https://raw.githubusercontent.com/.../questions/pack1.json" value={url} onChange={(e)=>setUrl(e.target.value)} />
                <button onClick={importURL} className="btn bg-slate-900 text-white">Importar URL</button>
              </div>
              <button onClick={exportBank} className="btn bg-slate-100 hover:bg-slate-200">Exportar banco actual</button>
            </div>
            <div className="text-xs text-slate-600 space-y-2">
              <p><strong>Consejo:</strong> publica tus JSON en <code>questions/</code> del repo y cárgalos por URL. La app fusiona varios bancos y usa <em>id</em> para distinguir nuevas vs ya jugadas.</p>
              <p><strong>Auto-carga:</strong> si creas <code>questions/manifest.json</code> con <code>{`{"files":["questions/pack1.json", ...]}`}</code>, la app intentará cargarlo al iniciar.</p>
            </div>
          </div>
        </section>
      );
    }

    // =================== SETUP ===================
    function Setup({ setup, setSetup, cats, total, available, filters, setFilters }){
      const setAllCats = (val)=> setFilters({...filters, cats:Object.fromEntries(Object.keys(cats).map(k=>[k,val]))});
      const setAllLvls = (val)=> setFilters({...filters, diffs:Object.fromEntries(Object.keys(DIFF).map(k=>[k,val]))});
      const valid = setup.playerCount>=1 && setup.playerCount<=4 && Array.from({length:setup.playerCount}).every((_,i)=> (setup.players[i]||'').trim().length>0);
      return (
        <section className="p-4 rounded-2xl border bg-white shadow-sm">
          <h2 className="text-lg font-bold mb-3">Configuración</h2>
          <div className="grid sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium">Jugadores</label>
              <div className="mt-2 flex gap-2">{[1,2,3,4].map(n=>(<Toggle key={n} on={setup.playerCount===n} onClick={()=>setSetup({...setup, playerCount:n})}>{n}</Toggle>))}</div>
              <div className="mt-2 grid grid-cols-2 gap-2">
                {Array.from({length:setup.playerCount}).map((_,i)=>(
                  <input key={i} value={setup.players[i]} onChange={(e)=>{ const p=[...setup.players]; p[i]=e.target.value; setSetup({...setup, players:p}); }} className="px-3 py-2 rounded-xl border" placeholder={`Jugador ${i+1}`} />
                ))}
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium">Meta y tiempo</label>
              <div className="mt-2 flex items-center gap-3">
                <div>
                  <div className="text-xs text-slate-500">Puntos para ganar</div>
                  <input type="number" min={3} max={50} value={setup.target} onChange={(e)=>setSetup({...setup, target:clamp(Number(e.target.value)||15,3,50)})} className="w-24 px-3 py-2 rounded-xl border" />
                </div>
                <div className="flex items-center gap-2 mt-2">
                  <input id="timerOn" type="checkbox" checked={setup.timerOn} onChange={(e)=>setSetup({...setup, timerOn:e.target.checked})} />
                  <label htmlFor="timerOn" className="text-sm">Temporizador</label>
                  <input type="number" min={5} max={90} value={setup.timePerQ} onChange={(e)=>setSetup({...setup, timePerQ:clamp(Number(e.target.value)||25,5,90)})} className="w-20 px-3 py-2 rounded-xl border" />
                  <span className="text-sm text-slate-500">seg</span>
                </div>
              </div>
            </div>
            <div>
              <div className="flex items-center justify-between">
                <label className="block text-sm font-medium">Categorías</label>
                <div className="flex gap-2 text-xs">
                  <button onClick={()=>setAllCats(true)} className="px-2 py-1 rounded bg-slate-100">Todas</button>
                  <button onClick={()=>setAllCats(false)} className="px-2 py-1 rounded bg-slate-100">Ninguna</button>
                </div>
              </div>
              <div className="mt-2 flex flex-wrap gap-2">
                {Object.entries(cats).map(([k,name])=> (
                  <Toggle key={k} on={!!filters.cats[k]} onClick={()=>setFilters({...filters, cats:{...filters.cats,[k]:!filters.cats[k]}})}>
                    <span className={cls('chip', (CATS[k]?.color || 'bg-slate-100 text-slate-800'))}>{name}</span>
                  </Toggle>
                ))}
              </div>
            </div>
            <div>
              <div className="flex items-center justify-between">
                <label className="block text-sm font-medium">Dificultad</label>
                <div className="flex gap-2 text-xs">
                  <button onClick={()=>setAllLvls(true)} className="px-2 py-1 rounded bg-slate-100">Todas</button>
                  <button onClick={()=>setAllLvls(false)} className="px-2 py-1 rounded bg-slate-100">Ninguna</button>
                </div>
              </div>
              <div className="mt-2 flex flex-wrap gap-2">
                {Object.entries(DIFF).map(([k,lab])=> (
                  <Toggle key={k} on={!!filters.diffs[k]} onClick={()=>setFilters({...filters, diffs:{...filters.diffs,[k]:!filters.diffs[k]}})}>
                    <span className={cls('chip', DIFF_COLOR[k])}>{lab}</span>
                  </Toggle>
                ))}
              </div>
              <div className="mt-2 text-xs text-slate-500">Preguntas disponibles: {available} / {total}</div>
            </div>
            <div className="col-span-full">
              <label className="block text-sm font-medium">Modo de selección</label>
              <div className="mt-2 flex flex-wrap gap-2 items-center">
                <Toggle on={filters.onlyNew} onClick={()=>setFilters({...filters, onlyNew:!filters.onlyNew})}>Usar solo <strong>nuevas</strong></Toggle>
                <Toggle on={filters.excludeArchived} onClick={()=>setFilters({...filters, excludeArchived:!filters.excludeArchived})}>Excluir <strong>archivadas</strong></Toggle>
                <button onClick={()=>{ if(confirm('¿Borrar historial de respondidas?')){ localStorage.removeItem(STORAGE.answered); location.reload(); } }} className="btn bg-rose-50 hover:bg-rose-100 text-rose-700 border border-rose-200">Reset historial</button>
              </div>
            </div>
          </div>
        </section>
      );
    }

    // =================== SCOREBOARD ===================
    function Scoreboard({ players, scores, target, current }){
      return (
        <section className="p-4 rounded-2xl border bg-white shadow-sm">
          <h3 className="text-lg font-bold mb-3">Marcador (meta: {target})</h3>
          <div className="grid sm:grid-cols-2 gap-3">
            {players.map((name,i)=>(
              <div key={i} className={cls('p-3 rounded-xl', i===current && 'ring-2 ring-slate-900')}>
                <div className="flex items-center justify-between text-sm">
                  <div className="font-semibold">{name}</div>
                  <div className="font-mono">{scores[i]} pts</div>
                </div>
                <div className="mt-2 h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                  <div className="h-full bg-slate-900" style={{width:`${Math.min(100,(scores[i]/target)*100)}%`}} />
                </div>
              </div>
            ))}
          </div>
        </section>
      );
    }

    // =================== GAME ===================
    function Game({ setup, deck, answered, setAnswered, archived, setArchived, onEnd }){
      const [idx, setIdx] = useState(0);
      const [currentPlayer, setCurrentPlayer] = useState(0);
      const [scores, setScores] = useState(Array(setup.playerCount).fill(0));
      const [selected, setSelected] = useState(null);
      const [locked, setLocked] = useState(false);
      const [feedback, setFeedback] = useState(null);
      const [timeLeft, setTimeLeft] = useState(setup.timerOn? setup.timePerQ: null);
      const timerRef = useRef(null);
      const q = deck[idx];

      useEffect(()=>{
        if(!setup.timerOn) return; setTimeLeft(setup.timePerQ);
        if(timerRef.current) clearInterval(timerRef.current);
        timerRef.current = setInterval(()=>{
          setTimeLeft(t=>{ if(t===null) return null; if(t<=1){ clearInterval(timerRef.current); handleAnswer(-1,true); return 0;} return t-1; });
        }, 1000);
        return ()=> timerRef.current && clearInterval(timerRef.current);
      }, [idx, setup.timerOn, setup.timePerQ]);

      if(!q){
        return (
          <section className="p-4 rounded-2xl border bg-white shadow-sm">
            <h3 className="text-lg font-bold">No quedan preguntas con los filtros seleccionados.</h3>
            <button onClick={onEnd} className="btn bg-slate-900 text-white mt-3">Volver</button>
          </section>
        );
      }

      const next = ()=>{
        const nextIdx=(idx+1)%deck.length; const nextPlayer=(currentPlayer+1)%setup.playerCount;
        setIdx(nextIdx); setCurrentPlayer(nextPlayer); setSelected(null); setLocked(false); setFeedback(null); setTimeLeft(setup.timerOn? setup.timePerQ:null);
      };

      const handleAnswer = (optIdx, dueToTimeout=false)=>{
        if(locked) return; setLocked(true);
        const correct = optIdx===q.correct;
        const sc=[...scores]; if(correct) sc[currentPlayer]+=1; setScores(sc);
        const ans=new Set(answered); ans.add(q.id); setAnswered(ans); lsSet(STORAGE.answered, Array.from(ans));
        setFeedback({correct, dueToTimeout});
        if(correct && sc[currentPlayer]>=setup.target){ setTimeout(()=>{ alert(`🏆 ¡${setup.players[currentPlayer]} gana!`); onEnd(); }, 400); return; }
        setTimeout(next, 900);
      };

      const toggleArchive = ()=>{ const arch=new Set(archived); if(arch.has(q.id)) arch.delete(q.id); else arch.add(q.id); setArchived(arch); lsSet(STORAGE.archived, Array.from(arch)); };

      const CatChip = ({cat})=> <span className={cls('chip', CATS[cat]?.color || 'bg-slate-100 text-slate-800')}>{CATS[cat]?.name||cat}</span>;
      const DiffChip = ({diff})=> <span className={cls('chip', DIFF_COLOR[diff] || 'bg-slate-100 text-slate-800')}>{DIFF[diff]||diff}</span>;

      return (
        <>
          <Scoreboard players={setup.players.slice(0, setup.playerCount)} scores={scores} target={setup.target} current={currentPlayer} />
          <section className="p-4 rounded-2xl border bg-white shadow-sm">
            <div className="flex items-center justify-between">
              <div className="flex gap-2 text-xs"><CatChip cat={q.cat}/><DiffChip diff={q.diff}/></div>
              {setup.timerOn && (<div className={`text-sm font-mono ${timeLeft!==null && timeLeft<=5?'text-rose-600':'text-slate-700'}`}>⏱ {timeLeft}s</div>)}
            </div>
            <h2 className="mt-3 text-xl font-bold">{q.q}</h2>
            <div className="mt-4 grid gap-2">
              {q.options.map((op,i)=>{
                const isC=i===q.correct; const picked=selected===i; const show=locked && (picked||isC);
                const base='w-full text-left px-4 py-3 rounded-xl border transition';
                const c=show? (isC? 'bg-emerald-50 border-emerald-300':'bg-rose-50 border-rose-300') : 'bg-white hover:bg-slate-50 border-slate-300';
                return (
                  <button key={i} disabled={locked} onClick={()=>{ setSelected(i); handleAnswer(i,false); }} className={`${base} ${c}`}>
                    <span className="font-medium">{String.fromCharCode(65+i)}.</span> {op}
                  </button>
                );
              })}
            </div>
            {locked && feedback && (
              <div className="mt-3 text-sm">
                {feedback.correct? (<span className="text-emerald-700 font-semibold">¡Correcto!</span>) : feedback.dueToTimeout? (<span className="text-rose-700">Tiempo agotado.</span>) : (<span className="text-rose-700">No es correcto.</span>)}
                {q.exp && (<div className="mt-1 text-slate-700"><span className="font-semibold">Explicación:</span> {q.exp}</div>)}
              </div>
            )}
            <div className="mt-4 flex items-center justify-between">
              <button onClick={toggleArchive} className="btn bg-slate-50 hover:bg-slate-100 border">{archived.has(q.id)? 'Desarchivar' : 'Archivar'} esta pregunta</button>
              <div className="text-sm text-slate-500">#{q.id}</div>
            </div>
          </section>
        </>
      );
    }

    // =================== HOWTO ===================
    function HowTo(){
      return (
        <details className="mt-6 p-4 rounded-2xl border bg-white shadow-sm">
          <summary className="cursor-pointer font-semibold">Cómo usar / Despliegue</summary>
          <div className="mt-3 text-sm space-y-2 text-slate-700">
            <p><strong>Importar preguntas:</strong> usa JSON con <code>{'{ version, categories, questions:[...] }'}</code>. Cada pregunta: <code>{'{ id, cat, diff, q, options:[4], correct, exp? }'}</code>.</p>
            <p><strong>Modo nuevas/archivadas:</strong> en Configuración puedes activar “Usar solo nuevas” y “Excluir archivadas”. Puedes archivar/desarchivar durante la partida.</p>
            <p><strong>Publicación:</strong> basta este <code>index.html</code> en GitHub Pages. Para ampliar la base, sube ficheros a <code>questions/</code> y cárgalos por URL. También puedes usar <code>questions/manifest.json</code> para auto-cargar.</p>
          </div>
        </details>
      );
    }

    // =================== APP ===================
    function App(){
      // estado setup
      const [setup, setSetup] = useState(lsGet(STORAGE.setup, { playerCount:2, players:['Jugador 1','Jugador 2','',''], target:15, timerOn:false, timePerQ:25 }));
      useEffect(()=>lsSet(STORAGE.setup, setup), [setup]);
      const [started, setStarted] = useState(false);
      const [answered, setAnswered] = useState(new Set(lsGet(STORAGE.answered, [])));
      const [archived, setArchived] = useState(new Set(lsGet(STORAGE.archived, [])));

      // banco activo + autoload manifest
      const [bank, setBank] = useState(EMBEDDED_BANK);
      useEffect(()=>{ (async()=>{
        try{ const manifestUrl = new URL('questions/manifest.json', location.href).href; const res = await fetch(manifestUrl, {cache:'no-store'}); if(res.ok){ const m = await res.json(); if(Array.isArray(m.files)){ const list=[bank]; for(const u of m.files){ try{ list.push(await fetchJSON(u)); }catch(e){ console.warn('No cargado',u,e); } } setBank(mergeBanks(list)); } } }
        catch(e){}
      })(); }, []);

      const [filters, setFilters] = useState({
        cats: Object.fromEntries(Object.keys(CATS).map(k=>[k,true])),
        diffs: Object.fromEntries(Object.keys(DIFF).map(k=>[k,true])),
        onlyNew:false,
        excludeArchived:true
      });

      const pool = useMemo(()=>{
        let list = sanitize(bank.questions);
        list = list.filter(q=> (filters.cats[q.cat]??true) && (filters.diffs[q.diff]??true));
        if(filters.onlyNew){ list = list.filter(q=> !answered.has(q.id) && !archived.has(q.id)); }
        if(filters.excludeArchived){ list = list.filter(q=> !archived.has(q.id)); }
        return shuffle(list);
      }, [bank, filters, answered, archived]);

      return (
        <div className="max-w-5xl mx-auto px-4 py-6">
          <header className="flex items-center justify-between gap-3">
            <Logo />
            <button onClick={()=>setStarted(false)} className="btn bg-slate-100 hover:bg-slate-200">Nueva partida</button>
          </header>

          {!started ? (
            <>
              <BankManager bank={bank} setBank={setBank} answered={answered} archived={archived} />
              <Setup setup={setup} setSetup={setSetup} cats={bank.categories||Object.fromEntries(Object.entries(CATS).map(([k,v])=>[k,v.name]))} total={(bank.questions||[]).length} available={pool.length} filters={filters} setFilters={setFilters} />
              <div className="mt-4 flex items-center justify-end">
                <button disabled={pool.length===0} onClick={()=>setStarted(true)} className={cls('px-4 py-2 rounded-2xl font-semibold', pool.length>0? 'bg-emerald-600 text-white hover:bg-emerald-700':'bg-slate-200 text-slate-500')}>¡Empezar!</button>
              </div>
              <HowTo />
            </>
          ) : (
            <Game setup={setup} deck={pool} answered={answered} setAnswered={setAnswered} archived={archived} setArchived={setArchived} onEnd={()=>setStarted(false)} />
          )}

          <footer className="mt-8 text-center text-xs text-slate-500">Banco: {bank.questions?.length||0} • Filtradas: {pool.length} • Versión: {bank.version}</footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
